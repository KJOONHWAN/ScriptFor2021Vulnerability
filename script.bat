@echo off
setlocal
chcp 437>nul
set DATETEXT=%date:-=%
set hh=%time:~0,2%
set hh1=%hh:~0,1%
set hh2=%hh:~1,1%
if "%hh1%" == " " set hh=0%hh2%
set TIMETEXT=%hh%%time:~3,2%%time:~6,2%

set RESULT_FILE=result_collect_%DATETEXT%%TIMETEXT%.txt

echo [Strat Script]
echo ====================== Windows Security Check Script Start ====================== > %RESULT_FILE%
echo. >> %RESULT_FILE%
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::  주요 정보 통신 기반 시설 | 계정 관리
::  - W-04 계정 잠금 임계값 설정
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
echo. W-04 START
echo [ W-04 계정 잠금 임계값 설정 START ] >> %RESULT_FILE%
echo. >> %RESULT_FILE%

secedit /export /cfg secpolicy_tmp.txt > nul
echo 1. 계정 잠금 임계값 설정 확인 >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"LockoutBadCount" > lockout.txt
if not "%ERRORLEVEL%" == "0" (
	echo Not Found LockoutBadCount >> %RESULT_FILE%
	call :FAILVALUE W-04
	goto QUIT
)
type lockout.txt >> %RESULT_FILE%
for /f "tokens=1,2 delims==" %%a in (lockout.txt) do set CONF=%%b
if not %CONF% LEQ 5 ( 
	call :FAILVALUE W-04
	goto QUIT
)
if %CONF% NEQ 0 (
	call :PASSVALUE W-04
) else (
	call :FAILVALUE W-04
)

:QUIT
echo. >> %RESULT_FILE%
echo [ W-04 계정 잠금 임계값 설정 END ] >> %RESULT_FILE%
echo. W-04 END
del /q secpolicy_tmp.txt
del /q lockout.txt

echo. >> %RESULT_FILE%
echo. W-55 START
echo [ W-55 최근 암호 기억 START ] >> %RESULT_FILE%
echo. >> %RESULT_FILE%

secedit /export /cfg secpolicy_tmp.txt > nul
type secpolicy_tmp.txt | findstr /bic:"PasswordHistorySize" > history.txt
type history.txt >> %RESULT_FILE%
for /f "tokens=1,2 delims==" %%a in (history.txt) do set CONF=%%b
if %CONF% GEQ 4 (
	call :PASSVALUE W-55
) else (
	call :FAILVALUE W-55
)

echo. >> %RESULT_FILE%
echo [ W-55 최근 암호 기억 END ] >> %RESULT_FILE%
echo. W-55 END
del /q secpolicy_tmp.txt
del /q history.txt

echo. >> %RESULT_FILE%
echo. W-69 START
echo [ W-69 정책에 따른 시스템 로깅 설정 START ] >> %RESULT_FILE%
echo. >> %RESULT_FILE%

set vulcount=0
secedit /export /cfg secpolicy_tmp.txt > nul
echo - 감사 정책 전체 설정 >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditObjectAccess" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditAccountManage" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditAccountLogon" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditPrivilegeUse" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditDSAccess" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditLogonEvents" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditSystemEvents" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditPolicyChange" >> %RESULT_FILE%
type secpolicy_tmp.txt | findstr /bic:"AuditProcessTracking" >> %RESULT_FILE%

for /f "tokens=1,2 delims==" %%a in ('"type secpolicy_tmp.txt | findstr /bic:"AuditAccountManage""') do set CONF=%%b
if %CONF% EQU 1 (
	set /A vulcount+=1
)

for /f "tokens=1,2 delims==" %%a in ('"type secpolicy_tmp.txt | findstr /bic:"AuditAccountLogon""') do set CONF=%%b
if %CONF% EQU 1 (
	set /A vulcount+=1
)

for /f "tokens=1,2 delims==" %%a in ('"type secpolicy_tmp.txt | findstr /bic:"AuditDSAccess""') do set CONF=%%b
if %CONF% EQU 1 (
	set /A vulcount+=1
)

for /f "tokens=1,2 delims==" %%a in ('"type secpolicy_tmp.txt | findstr /bic:"AuditLogonEvents""') do set CONF=%%b
if %CONF% EQU 3 (
	set /A vulcount+=1
)

for /f "tokens=1,2 delims==" %%a in ('"type secpolicy_tmp.txt | findstr /bic:"AuditSystemEvents""') do set CONF=%%b
if %CONF% EQU 3 (
	set /A vulcount+=1
)

for /f "tokens=1,2 delims==" %%a in ('"type secpolicy_tmp.txt | findstr /bic:"AuditPolicyChange""') do set CONF=%%b
if %CONF% EQU 1 (
	set /A vulcount+=1
)

if %vulcount% EQU 6 (
	call :PASSVALUE W-69
) else (
	call :FAILVALUE W-69
)
echo. >> %RESULT_FILE%
echo [ W-69 정책에 따른 시스템 로깅 설정 END ] >> %RESULT_FILE%

echo. W-69 END
del /q secpolicy_tmp.txt

echo. >> %RESULT_FILE%
echo. W-38 START
echo [ W-38 화면보호기 설정 START ] >> %RESULT_FILE%
echo. >> %RESULT_FILE%
set vulcount=0

reg query "HKEY_CURRENT_USER\Control Panel\Desktop" | find "ScreenSaveActive" > active.txt
type active.txt >> %RESULT_FILE%
for /f "tokens=3" %%a in (active.txt) do set ACTCONF=%%a
if "%ACTCONF%" == "1" (
	set /a vulcount=%vulcount%+1
)

reg query "HKEY_CURRENT_USER\Control Panel\Desktop" | find "ScreenSaverIsSecure" > secure.txt
type secure.txt >> %RESULT_FILE%
for /f "tokens=3" %%a in (secure.txt) do set SECCONF=%%a
if "%SECCONF%" == "1" (
	set /a vulcount=%vulcount%+1
)
reg query "HKEY_CURRENT_USER\Control Panel\Desktop" | find "ScreenSaveTimeOut" > timeout.txt
type timeout.txt >> %RESULT_FILE%
for /f "tokens=3" %%a in (timeout.txt) do set TIMECONF=%%a
if "%TIMECONF%" LEQ "600" (
	set /a vulcount=%vulcount%+1
)

if "%vulcount%" EQU "3" (
	call :PASSVALUE W-38
) else (
	call :FAILVALUE W-38
)
echo. >> %RESULT_FILE%
echo [ W-38 화면보호기 설정 END ] >> %RESULT_FILE%
echo. W-38 END
del /q active.txt
del /q secure.txt
del /q timeout.txt

exit /b 0
:PASSVALUE
echo [ %1 ] : 양호 >> %RESULT_FILE%
exit /b

:FAILVALUE
echo [ %1 ] : 취약 >> %RESULT_FILE%
exit /b
